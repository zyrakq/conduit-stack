
# üåê Conduit Matrix Server

A modular Docker Compose configuration system for Conduit Matrix homeserver with support for multiple environments and OIDC integration capabilities.

## üöÄ Quick Start

### 1. Build Configurations

Use the stackbuilder utility to build all configurations:

```bash
sb build
```

This will create all combinations in the `build/` directory based on [`stackbuilder.toml`](stackbuilder.toml).

### 2. Choose Your Configuration

Navigate to the desired configuration directory:

```bash
# For development with port forwarding
cd build/forwarding/base/

# For production with Let's Encrypt SSL
cd build/letsencrypt/base/

# For production with Step CA SSL
cd build/step-ca/base/
```

### 3. Configure Environment

Copy and edit the environment file:

```bash
cp .env.example .env
# Edit .env with your values
```

### 4. Deploy

Start the services:

```bash
docker compose up --build -d
```

Access: `http://localhost:6167` (for forwarding mode)

## üìÅ Project Structure

- **`build/`** - Final Docker Compose configurations ready to deploy
- **`components/`** - Source components used to build final configurations
  - `base/` - Base Conduit components
  - `environments/` - Environment components (devcontainer, forwarding, letsencrypt, step-ca)
  - `extensions/` - Extensions (oidc, coturn, step-ca-trust)

The `build/` directory contains ready-to-use configurations generated by `sb build` command. The `components/` directory contains the source files that are combined to create these final configurations.

## üîß Available Configurations

### Environments

- **devcontainer**: Development environment with workspace network
- **forwarding**: Development environment with port forwarding (6167:6167)
- **letsencrypt**: Production with Let's Encrypt SSL certificates
- **step-ca**: Production with Step CA SSL certificates

### Extensions

- **oidc**: OIDC authentication integration for enhanced authentication
- **coturn**: TURN server integration for voice and video calls
- **step-ca-trust**: Step CA certificate trust integration

## üîê Environment Variables

### Base Configuration

- `COMPOSE_PROJECT_NAME`: Project name for Docker Compose
- `CONDUIT_SERVER_NAME`: Matrix server name (e.g., matrix.example.com)
- `CONDUIT_DATABASE_PATH`: Database storage path (default: /var/lib/matrix-conduit/)
- `CONDUIT_DATABASE_BACKEND`: Database backend (default: rocksdb)
- `CONDUIT_PORT`: Conduit service port (default: 6167)
- `CONDUIT_MAX_REQUEST_SIZE`: Maximum request size in bytes (default: 20000000)
- `CONDUIT_ALLOW_REGISTRATION`: Allow user registration (default: false)
- `CONDUIT_REGISTRATION_TOKEN`: Registration token for user signup
- `CONDUIT_ALLOW_FEDERATION`: Enable Matrix federation (default: true)
- `CONDUIT_ALLOW_CHECK_FOR_UPDATES`: Allow update checks (default: true)
- `CONDUIT_TRUSTED_SERVERS`: List of trusted Matrix servers (default: ["matrix.org"])
- `CONDUIT_ADDRESS`: Bind address (default: 0.0.0.0)
- `CONDUIT_CONFIG`: Path to custom configuration file
- `GLOBAL_MEDIA_RETENTION_SPACE`: Maximum space for media files (default: 5G)
- `GLOBAL_MEDIA_RETENTION_ACCESSED`: Retention period for accessed media (default: 30d)
- `GLOBAL_MEDIA_RETENTION_CREATED`: Retention period for created media (default: 30d)

### Let's Encrypt Configuration

- `VIRTUAL_PORT`: Port for nginx-proxy (default: 6167)
- `VIRTUAL_HOST`: Domain for nginx-proxy (e.g., matrix.example.com)
- `LETSENCRYPT_HOST`: Domain for SSL certificate
- `LETSENCRYPT_EMAIL`: Email for certificate registration
- `WELL_KNOWN_VIRTUAL_PORT`: Port for well-known service (default: 80)
- `WELL_KNOWN_VIRTUAL_HOST`: Domain for well-known service (e.g., example.com)
- `WELL_KNOWN_LETSENCRYPT_HOST`: Domain for well-known SSL certificate
- `WELL_KNOWN_LETSENCRYPT_EMAIL`: Email for well-known certificate registration

### Step CA Configuration

- `VIRTUAL_PORT`: Port for nginx-proxy (default: 6167)
- `VIRTUAL_HOST`: Domain for nginx-proxy (e.g., matrix.example.local)
- `LETSENCRYPT_HOST`: Domain for SSL certificate
- `LETSENCRYPT_EMAIL`: Email for certificate registration
- `WELL_KNOWN_VIRTUAL_PORT`: Port for well-known service (default: 80)
- `WELL_KNOWN_VIRTUAL_HOST`: Domain for well-known service (e.g., example.com)
- `WELL_KNOWN_LETSENCRYPT_HOST`: Domain for well-known SSL certificate
- `WELL_KNOWN_LETSENCRYPT_EMAIL`: Email for well-known certificate registration

### OIDC Configuration

- `CONDUIT_CONFIG`: Path to custom configuration file (default: /matrix-conduit/conduit.toml)
- `CONDUIT_IDPS_SSO_ISSUER`: OIDC issuer URL (e.g., <https://sso.example.com/realms/matrix>)
- `CONDUIT_IDPS_SSO_NAME`: SSO provider display name (default: SSO)
- `CONDUIT_IDPS_SSO_ICON`: SSO provider icon URL
- `CONDUIT_IDPS_SSO_SCOPES`: OIDC scopes (default: ["openid", "profile", "email", "groups"])
- `CONDUIT_IDPS_SSO_CLIENT_ID`: OIDC client ID for Conduit
- `CONDUIT_IDPS_SSO_CLIENT_SECRET`: OIDC client secret
- `CONDUIT_IDPS_SSO_AUTH_METHOD`: Authentication method (default: basic)
- `CONDUIT_IDPS_SSO_REDIRECT_URL`: OAuth callback URL (optional)

### Step CA Trust Configuration

- `STEP_CA_TRUST`: Enable Step CA certificate trust (default: true)
- `STEP_CA_TRUST_RESTART`: Restart container when trust configuration changes (default: true)

The step-ca-trust extension automatically configures containers to trust certificates issued by Step CA, enabling secure communication with Step CA-protected services.

### TURN Configuration

- `CONDUIT_TURN_URIS`: List of TURN server URIs for voice and video calls (e.g., ["turn:example.com?transport=udp", "turn:example.com?transport=tcp"])
- `CONDUIT_TURN_SECRET`: Shared secret for TURN server authentication

The TURN extension enables voice and video calling functionality by configuring TURN servers for NAT traversal and media relay.

## üîê OIDC Integration

The OIDC extension provides integration with external identity providers for enhanced authentication and user management.

### Using OIDC Extension

1. **Build with OIDC extension:**

   ```bash
   sb build
   ```

2. **Choose OIDC-enabled configuration:**

   ```bash
   # For development with OIDC
   cd build/forwarding/oidc/
   
   # For production with Let's Encrypt and OIDC
   cd build/letsencrypt/oidc/
   ```

3. **Configure identity provider:**

   ```bash
   cp .env.example .env
   # Edit .env with your identity provider details
   ```

4. **Example OIDC configuration:**

   ```bash
   CONDUIT_SERVER_NAME=matrix.example.com
   CONDUIT_IDPS_SSO_ISSUER=https://sso.example.com/realms/matrix
   CONDUIT_IDPS_SSO_CLIENT_ID=conduit
   CONDUIT_IDPS_SSO_CLIENT_SECRET=your-client-secret
   ```

5. **Deploy:**

   ```bash
   docker compose up --build -d
   ```

## üìû TURN Integration

The TURN extension provides voice and video calling capabilities for Matrix clients by configuring TURN servers for NAT traversal and media relay.

### Using TURN Extension

1. **Build with TURN extension:**

   ```bash
   sb build
   ```

2. **Choose TURN-enabled configuration:**

   ```bash
   # For development with TURN
   cd build/forwarding/coturn/
   
   # For production with Let's Encrypt and TURN
   cd build/letsencrypt/coturn/
   ```

3. **Configure TURN servers:**

   ```bash
   cp .env.example .env
   # Edit .env with your TURN server details
   ```

4. **Example TURN configuration:**

   ```bash
   CONDUIT_SERVER_NAME=matrix.example.com
   CONDUIT_TURN_URIS='["turn:turn.example.com?transport=udp", "turn:turn.example.com?transport=tcp"]'
   CONDUIT_TURN_SECRET=your-turn-secret
   ```

5. **Deploy:**

   ```bash
   docker compose up --build -d
   ```

### TURN Server Requirements

For voice and video calls to work properly, you need:

- **TURN Server**: A properly configured TURN server (coturn, eturnal, etc.)
- **Network Access**: TURN server accessible from client networks
- **Authentication**: Shared secret between Conduit and TURN server
- **Protocols**: Support for both UDP and TCP transport
- **Firewall**: Proper firewall configuration for TURN ports

### TURN Server Examples

Popular TURN server implementations:

- **Coturn**: Open-source TURN server with extensive configuration options
- **Eturnal**: Modern Erlang-based TURN server with STUN support
- **Pion TURN**: Go-based TURN server with WebRTC focus

## üîí Security

‚ö†Ô∏è **Production Checklist:**

- Configure proper server name and federation settings
- Set up proper firewall rules
- Regular security updates
- Configure rate limiting
- Set up proper logging
- Validate SSL certificates
- Secure registration tokens
- Review federation settings

## üÜò Troubleshooting

**Build Issues:**

- Ensure stackbuilder is installed: <https://github.com/zyrakq/stackbuilder>
- Check component file syntax
- Verify all required files exist

**Conduit Issues:**

- Check configuration syntax
- Verify database permissions
- Review container logs: `docker logs conduit`
- Check network connectivity

**SSL Issues:**

- **Let's Encrypt**: Verify domain DNS and letsencrypt-manager
- **Step CA**: Check step-ca-manager and virtual network config

**Federation Issues:**

- Verify server name configuration
- Check well-known delegation setup
- Validate SSL certificates
- Check firewall and port configuration

**OIDC Issues:**

- Verify OIDC provider configuration
- Check client ID and secret
- Validate redirect URLs
- Review OIDC provider logs

**TURN Issues:**

- Verify TURN server accessibility
- Check TURN server configuration
- Validate shared secret
- Test TURN connectivity with tools like `turnutils_uclient`
- Review TURN server logs
- Check firewall rules for TURN ports

## üìù Notes

- The `build/` directory is automatically generated by `sb build` and should not be edited manually
- Environment variables in generated files use `$VARIABLE_NAME` format for proper interpolation
- Each generated configuration includes a complete `docker-compose.yml` and `.env.example`
- User `.env` files are preserved during rebuilds
- Configurations are built using stackbuilder based on [`stackbuilder.toml`](stackbuilder.toml)

## üéØ Conduit Features

The Conduit configuration includes:

- **Lightweight**: Rust-based Matrix homeserver with minimal resource usage
- **Federation**: Full Matrix federation support
- **Database**: RocksDB backend for optimal performance
- **Registration**: Configurable user registration with token support
- **OIDC**: External authentication provider integration
- **TURN**: Voice and video calling support with TURN server integration
- **Well-known**: Automatic Matrix well-known delegation setup
- **SSL**: Full SSL/TLS support with Let's Encrypt and Step CA
- **Updates**: Automatic update checking capability
- **Trusted Servers**: Configurable trusted server list

## üîÑ Database Migration

If you need to migrate your Conduit database between different backends (e.g., from RocksDB to SQLite), use the [Conduit Database Migration Tool](../conduit-migrate/). This tool provides a safe way to migrate your Matrix data without losing information.

## ‚öôÔ∏è Advanced Configuration

For detailed configuration options of the Conduit Matrix
