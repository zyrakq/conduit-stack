services:
  conduit:
    container_name: conduit
    image: matrixconduit/matrix-conduit:latest
    restart: unless-stopped
    volumes:
      - conduit-db:/var/lib/matrix-conduit/
    environment:
      CONDUIT_SERVER_NAME: ${CONDUIT_SERVER_NAME}
      CONDUIT_DATABASE_PATH: ${CONDUIT_DATABASE_PATH}
      CONDUIT_DATABASE_BACKEND: ${CONDUIT_DATABASE_BACKEND}
      CONDUIT_PORT: ${CONDUIT_PORT}
      CONDUIT_MAX_REQUEST_SIZE: ${CONDUIT_MAX_REQUEST_SIZE}
      CONDUIT_ALLOW_REGISTRATION: ${CONDUIT_ALLOW_REGISTRATION}
      # CONDUIT_REGISTRATION_TOKEN: ${CONDUIT_REGISTRATION_TOKEN}
      CONDUIT_ALLOW_FEDERATION: ${CONDUIT_ALLOW_FEDERATION}
      CONDUIT_ALLOW_CHECK_FOR_UPDATES: ${CONDUIT_ALLOW_CHECK_FOR_UPDATES}
      CONDUIT_TRUSTED_SERVERS: ${CONDUIT_TRUSTED_SERVERS}
      CONDUIT_ADDRESS: ${CONDUIT_ADDRESS}
      CONDUIT_CONFIG: ${CONDUIT_CONFIG:-/matrix-conduit/conduit.toml}
      VIRTUAL_PORT: ${VIRTUAL_PORT:-$CONDUIT_PORT}
      VIRTUAL_HOST: ${VIRTUAL_HOST}
      LETSENCRYPT_HOST: ${LETSENCRYPT_HOST}
      LETSENCRYPT_EMAIL: ${LETSENCRYPT_EMAIL}
    configs:
      - source: conduit-config
        target: ${CONDUIT_CONFIG:-/matrix-conduit/conduit.toml}
    logging:
      driver: "json-file"
      options:
        max-size: 10m
        max-file: 3
    networks:
      - matrix-network
      - letsencrypt-network
  conduit-reverse:
    container_name: conduit-reverse
    image: ferronserver/ferron:2
    restart: unless-stopped
    environment:
      VIRTUAL_PORT: ${WELL_KNOWN_VIRTUAL_PORT:-80}
      VIRTUAL_HOST: ${WELL_KNOWN_VIRTUAL_HOST}
      LETSENCRYPT_HOST: ${WELL_KNOWN_LETSENCRYPT_HOST}
      LETSENCRYPT_EMAIL: ${WELL_KNOWN_LETSENCRYPT_EMAIL}
    logging:
      driver: "json-file"
      options:
        max-size: 10m
        max-file: 3
    depends_on:
      - conduit
    configs:
      - source: conduit-reverse-conf
        target: /etc/ferron.kdl
    networks:
      - letsencrypt-network
configs:
  conduit-config:
    content: |
      [global]
      server_name = "${CONDUIT_SERVER_NAME}"

      [global.media]
      backend = "filesystem"

      [[global.media.retention]]
      space = "${GLOBAL_MEDIA_RETENTION_SPACE:-5G}"
      accessed = "${GLOBAL_MEDIA_RETENTION_ACCESSED:-30d}"
      created = "${GLOBAL_MEDIA_RETENTION_CREATED:-30d}"
  conduit-reverse-conf:
    content: |
      *:80 {
          location "/.well-known" {
              proxy "http://conduit:${VIRTUAL_PORT:-$CONDUIT_PORT}"
          }
          location "/_matrix" {
              proxy "http://conduit:${VIRTUAL_PORT:-$CONDUIT_PORT}"
          }
      }
volumes:
  conduit-db:
    name: conduit-db
networks:
  matrix-network:
    name: matrix-network
  letsencrypt-network:
    external: true
